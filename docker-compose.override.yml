services:

  # Local services are available on their ports, but also available on:
  # http://api.localhost.tiangolo.com: backend
  # http://dashboard.localhost.tiangolo.com: frontend
  # etc. To enable it, update .env, set:
  # DOMAIN=localhost.tiangolo.com
  proxy:
    image: traefik:v3.6
    environment:
      - DOCKER_API_VERSION=1.44
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - "8094:80"
      - "8095:8080"
    # Duplicate the command from docker-compose.yml to add --api.insecure=true
    command:
      # Enable Docker in Traefik, so that it reads labels from Docker services
      - --providers.docker
      # Add a constraint to only use services with the label for this stack
      - --providers.docker.constraints=Label(`traefik.constraint-label`, `traefik-public`)
      # Do not expose all Docker services, only the ones explicitly exposed
      - --providers.docker.exposedbydefault=false
      # Create an entrypoint "http" listening on port 80
      - --entrypoints.http.address=:80
      # Create an entrypoint "https" listening on port 443
      - --entrypoints.https.address=:443
      # Enable the access log, with HTTP requests
      - --accesslog
      # Enable the Traefik log, for configurations and errors
      - --log
      # Enable debug logging for local development
      - --log.level=DEBUG
      # Enable the Dashboard and API
      - --api
      # Enable the Dashboard and API in insecure mode for local development
      - --api.insecure=true
    labels:
      # Enable Traefik for this service, to make it available in the public network
      - traefik.enable=true
      - traefik.constraint-label=traefik-public
      # Dummy https-redirect middleware that doesn't really redirect, only to
      # allow running it locally
      - traefik.http.middlewares.https-redirect.contenttype.autodetect=false
    networks:
      - traefik-public
      - default

  db:
    restart: "no"
    ports:
      - "5434:5432"

  prestart:
    restart: "no"
    # Mount backend directory so prestart sees latest migrations
    volumes:
      - ./backend/app:/app/app
      - ./backend/alembic.ini:/app/alembic.ini

  adminer:
    restart: "no"
    ports:
      - "8083:8080"

  backend:
    restart: "no"
    deploy:
      replicas: 1
    ports:
      - "8020:8000"
    build:
      context: ./backend
    # command: sleep infinity  # Infinite loop to keep container alive doing nothing
    command:
      - fastapi
      - run
      - --reload
      - "app/main.py"
    # Mount backend directory for live code changes
    volumes:
      - ./backend/app:/app/app
      - ./backend/tests:/app/tests
      - ./backend/alembic.ini:/app/alembic.ini
      - ./backend/htmlcov:/app/htmlcov
    develop:
      watch:
        - path: ./backend
          action: sync
          target: /app
          ignore:
            - ./backend/.venv
            - .venv
        - path: ./backend/pyproject.toml
          action: rebuild
    environment:
      SMTP_HOST: "mailcatcher"
      SMTP_PORT: "1025"
      SMTP_TLS: "false"
      EMAILS_FROM_EMAIL: "noreply@example.com"

  mailcatcher:
    image: schickling/mailcatcher
    ports:
      - "1083:1080"
      - "1028:1025"

  db-init:
    image: '${DOCKER_IMAGE_BACKEND?Variable not set}:${TAG-latest}'
    build:
      context: ./backend
    restart: "no"
    depends_on:
      db:
        condition: service_healthy
      prestart:
        condition: service_completed_successfully
    env_file:
      - .env
    environment:
      - POSTGRES_SERVER=db
      - POSTGRES_PORT=${POSTGRES_PORT}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_USER=${POSTGRES_USER?Variable not set}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD?Variable not set}
      # Configure automatic seeding
      - AUTO_SEED_DB=${AUTO_SEED_DB:-true}
      - SEED_USER_COUNT=${SEED_USER_COUNT:-10}
      - SEED_ALGORITHM_COUNT=${SEED_ALGORITHM_COUNT:-15}
      - SEED_AGENT_SESSION_COUNT=${SEED_AGENT_SESSION_COUNT:-20}
      - SEED_COLLECT_REAL_DATA=${SEED_COLLECT_REAL_DATA:-true}
    volumes:
      - ./backend/app:/app/app
    command: >
      bash -c "
      if [ \"$$AUTO_SEED_DB\" = \"true\" ]; then
        echo 'Checking if database needs seeding...';
        python -c '
      from sqlmodel import Session, select, func
      from app.core.db import engine
      from app.models import User
      
      with Session(engine) as session:
          user_count = session.exec(select(func.count(User.id))).one()
          if user_count == 0:
              print(\"Database is empty. Seeding with dev data...\")
              exit(0)
          else:
              print(f\"Database already has {user_count} users. Skipping seed.\")
              exit(1)
      ' && python -m app.utils.seed_data --all --users $$SEED_USER_COUNT --algorithms $$SEED_ALGORITHM_COUNT --agent-sessions $$SEED_AGENT_SESSION_COUNT $$([ \"$$SEED_COLLECT_REAL_DATA\" = \"false\" ] && echo \"--no-real-data\" || echo \"\") || echo 'Database already seeded.';
      else
        echo 'AUTO_SEED_DB is disabled. Skipping automatic seeding.';
      fi
      "

  frontend:
    restart: "no"
    deploy:
      replicas: 1
    ports:
      - "5176:80"
    build:
      context: ./frontend
      args:
        - VITE_API_URL=http://localhost:8000
        - NODE_ENV=development

  playwright:
    build:
      context: ./frontend
      dockerfile: Dockerfile.playwright
      args:
        - VITE_API_URL=http://backend:8000
        - NODE_ENV=production
    ipc: host
    depends_on:
      - backend
      - mailcatcher
    env_file:
      - .env
    environment:
      - VITE_API_URL=http://backend:8000
      - MAILCATCHER_HOST=http://mailcatcher:1080
      # For the reports when run locally
      - PLAYWRIGHT_HTML_HOST=0.0.0.0
      - CI=${CI}
    volumes:
      - ./frontend/blob-report:/app/blob-report
      - ./frontend/test-results:/app/test-results
    ports:
      - 9323:9323

networks:
  traefik-public:
    # For local dev, don't expect an external Traefik network
    external: false
