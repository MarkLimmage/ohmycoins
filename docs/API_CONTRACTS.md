# API-Frontend Integration Contracts

**Version**: 1.0  
**Date**: 2026-01-24  
**Status**: ACTIVE  
**Purpose**: Define API interaction patterns and UI behavior contracts

---

## Purpose & Scope

This document defines **patterns** and **UI behaviors** for API interactions. For exact schemas, **the FastAPI OpenAPI/Swagger documentation is the single source of truth**.

### What This Document Contains:
- üéØ **Interaction Patterns**: How the UI handles common API states (loading, error, success)
- üî¥ **Error Handling Standards**: User-facing messages for HTTP error codes
- üì± **UI Behavior Contracts**: What the frontend displays during API operations
- üîê **Authentication Flows**: Token refresh, session expiry patterns
- ‚ö° **Real-Time Communication**: WebSocket patterns and fallback strategies

### What This Document Does NOT Contain:
- ‚ùå Exact request/response schemas (use Pydantic models in OpenAPI)
- ‚ùå Complete endpoint catalog (auto-generated by FastAPI)
- ‚ùå Field-level validation rules (defined in code)

---

## Global API Patterns

### Pattern 1: Authentication & Authorization

#### Token-Based Authentication
**Backend Implementation**: JWT tokens (access + refresh)

**Frontend Behavior**:
```typescript
// Access Token Lifecycle
- Stored in: memory (React state/context)
- Lifespan: 30 minutes
- Sent via: Authorization: Bearer <token> header
- Refresh trigger: 401 Unauthorized response

// Refresh Token Lifecycle
- Stored in: httpOnly cookie
- Lifespan: 7 days
- Used to: obtain new access token
- Failure action: redirect to /login
```

**UI States**:
| State | UI Behavior | Backend Response |
|-------|-------------|------------------|
| Authenticated | Normal operation | 200 OK |
| Token expired | Automatic silent refresh | 401 ‚Üí POST /api/v1/auth/refresh |
| Refresh failed | Redirect to login, show "Session expired" | 401 on refresh endpoint |
| Invalid token | Show "Authentication error" | 403 Forbidden |

**Error Messages**:
- 401 on protected route: "Your session has expired. Please log in again."
- 403 (permission denied): "You don't have permission to access this resource."
- Network error during refresh: "Connection lost. Retrying..."

**Requirements**: Consistent across all protected endpoints

---

### Pattern 2: Loading States

#### Progressive Loading Strategy
**Principle**: Show content incrementally, never block entire UI

**UI Patterns**:

**Small Actions** (< 2s expected):
- Button with inline spinner: `[‚è≥ Saving...]`
- Disable button during operation
- On success: brief success state (green checkmark, 1s)
- On error: inline error message below button

**Data Fetching** (2-5s expected):
- Skeleton screens for data-heavy components
- Preserve layout (no content jump)
- Show approximate data shape (e.g., 3 skeleton ledger cards)

**Long Operations** (> 5s expected):
- Full modal with progress indicator
- Steps shown: "Validating...", "Processing...", "Complete"
- Allow cancellation if backend supports it
- On success: show summary before closing

**Background Operations** (real-time updates):
- Toast notifications for non-critical updates
- Badge counts for new items (e.g., "3 new Catalyst events")
- Subtle animations (pulse, fade-in)

**Code Example** (React Query pattern):
```typescript
const { data, isLoading, error } = useQuery('ledger-data', fetchLedgerData);

if (isLoading) return <LedgerCardSkeleton />;
if (error) return <ErrorBanner retry={() => refetch()} />;
return <LedgerCard data={data} />;
```

---

### Pattern 3: Error Handling

#### HTTP Status Code Mapping

**4xx Client Errors** (User-fixable):
| Code | Meaning | User-Facing Message | UI Action |
|------|---------|---------------------|-----------|
| 400 | Bad Request | "Invalid data. Please check your input." | Highlight invalid fields inline |
| 401 | Unauthorized | "Session expired. Please log in again." | Redirect to /login |
| 403 | Forbidden | "You don't have permission for this action." | Disable button, show tooltip |
| 404 | Not Found | "This resource no longer exists." | Show empty state or redirect |
| 409 | Conflict | "This action conflicts with existing data." | Show conflict details, suggest resolution |
| 422 | Validation Error | "Some fields have errors. See below." | Inline field-level errors from backend |
| 429 | Rate Limit | "Too many requests. Please wait [X] seconds." | Show countdown timer, disable actions |

**5xx Server Errors** (System issues):
| Code | Meaning | User-Facing Message | UI Action |
|------|---------|---------------------|-----------|
| 500 | Internal Error | "Something went wrong. Please try again." | Retry button, copy error ID |
| 502 | Bad Gateway | "Service temporarily unavailable." | Retry with exponential backoff |
| 503 | Service Unavailable | "System maintenance in progress." | Show maintenance banner |
| 504 | Gateway Timeout | "Request timed out. Please try again." | Retry button |

**Network Errors** (No response):
| Error Type | User-Facing Message | UI Action |
|------------|---------------------|-----------|
| `ERR_NETWORK` | "No internet connection. Retrying..." | Auto-retry every 5s, show toast |
| `ERR_CONNECTION_REFUSED` | "Cannot reach server. Please check your connection." | Retry button |
| `ERR_TIMEOUT` | "Request timed out. Please try again." | Retry button |

#### Error Display Patterns

**Inline Errors** (Field-level validation):
```
[Input Field]
‚ùå API keys must start with 'sk-' or 'sk-proj-'
```

**Banner Errors** (Page-level issues):
```
‚ö†Ô∏è Unable to load Ledger data
Last updated: 2 minutes ago | [Retry] [Dismiss]
```

**Modal Errors** (Blocking operations):
```
‚ùå Failed to Deploy Algorithm

Error: Trading API key not configured

[Go to Settings] [Cancel]
```

**Toast Errors** (Non-critical notifications):
```
üî¥ Background sync failed. Will retry in 30s.
```

---

### Pattern 4: Optimistic UI Updates

#### When to Use Optimistic UI
**Use for**:
- User-initiated actions with high success rate (> 95%)
- Operations that feel instantaneous (< 500ms backend)
- Non-critical data mutations

**Do NOT use for**:
- Financial transactions (trades, transfers)
- Permission-sensitive operations (delete account, API key updates)
- Multi-step workflows

#### Implementation Pattern
```typescript
// Example: Updating user preferences
const { mutate } = useMutation(updatePreferences, {
  onMutate: async (newPrefs) => {
    // 1. Cancel outgoing queries
    await queryClient.cancelQueries('preferences');
    
    // 2. Save rollback data
    const previousPrefs = queryClient.getQueryData('preferences');
    
    // 3. Optimistically update UI
    queryClient.setQueryData('preferences', newPrefs);
    
    // 4. Return rollback context
    return { previousPrefs };
  },
  onError: (err, newPrefs, context) => {
    // Rollback on error
    queryClient.setQueryData('preferences', context.previousPrefs);
    showToast('Failed to update preferences', 'error');
  },
  onSuccess: () => {
    showToast('Preferences updated', 'success');
  }
});
```

---

### Pattern 5: Real-Time Communication (WebSocket)

#### WebSocket Connection Lifecycle

**Connection States**:
| State | UI Indicator | User Actions | Reconnection |
|-------|--------------|--------------|--------------|
| CONNECTING | "Connecting..." spinner | All real-time features disabled | Initial attempt |
| OPEN | Green dot "Live" | All features enabled | N/A |
| DISCONNECTED | Red banner "DISCONNECTED" | Fallback to polling (5s) | Auto-retry every 2s (exponential backoff) |
| FAILED | Red banner "Connection failed" | Manual "Reconnect" button | User-triggered only |

**WebSocket URL Pattern**:
```
wss://{domain}/ws/{resource}/{id}?token={jwt_token}

Examples:
- wss://api.ohmycoins.com/ws/catalyst/live?token=...
- wss://api.ohmycoins.com/ws/agent/session/abc-123?token=...
- wss://api.ohmycoins.com/ws/floor/pnl?token=...
```

**Message Format** (JSON):
```json
{
  "type": "catalyst_event" | "agent_message" | "pnl_update",
  "timestamp": "2026-01-24T16:45:23Z",
  "data": { ... }
}
```

#### Fallback Strategy (Disconnected State)

**Problem**: WebSocket drops during critical operation (e.g., trading)

**Solution**:
1. **Visual Indicator**: Red "DISCONNECTED" banner at top
2. **Data Staleness**: Show "Last updated: X seconds ago"
3. **Fallback to Polling**:
   - Critical data (P&L, positions): Poll every 2s via REST API
   - Non-critical data (Ledgers): Poll every 10s
4. **Reconnection Attempts**:
   - Attempt 1: Immediate
   - Attempt 2-5: Every 2s
   - Attempt 6+: Every 10s (max 50 attempts)
   - User can manually trigger "Reconnect Now"
5. **Critical Action Fallback**:
   - Kill Switch uses POST /api/v1/floor/emergency-stop (REST fallback)
   - If REST also fails: Show "MANUAL INTERVENTION REQUIRED" with support contact

**Requirements**: REQ-FL-DISC-001

---

## Feature-Specific Patterns

### Feature: BYOM (Bring Your Own Model)

#### API Key Management

**Endpoint Pattern**: `/api/v1/users/me/llm-credentials`

**Frontend Component**: `APIKeyInput.tsx`

**User Flow**:
1. User selects provider (OpenAI, Google, Anthropic)
2. User enters API key (masked input: `type="password"`)
3. User clicks "Test Connection" (optional but recommended)
4. Backend validates key with provider
5. User clicks "Save" (disabled until test passes)
6. Key encrypted and stored

**HTTP Responses**:

**Success (200)**:
```json
{
  "id": "cred-abc-123",
  "provider": "openai",
  "model_name": "gpt-4",
  "masked_key": "sk-proj-***...xyz",
  "is_default": true,
  "created_at": "2026-01-24T16:45:23Z"
}
```

**UI Behavior**: 
- Green checkmark animation
- Success toast: "OpenAI API key saved successfully"
- Form closes, settings page shows masked key

**Error (400 - Invalid Format)**:
```json
{
  "detail": "API key format invalid. OpenAI keys start with 'sk-' or 'sk-proj-'"
}
```

**UI Behavior**:
- Red X icon below input field
- Error message: "The API key format is incorrect. Keys should start with 'sk-'."
- Link: "How to get your API key" ‚Üí https://platform.openai.com/api-keys
- Keep form open, allow user to edit

**Error (401 - Authentication Failed)**:
```json
{
  "detail": "Could not authenticate with OpenAI API"
}
```

**UI Behavior**:
- Error message: "Could not authenticate with OpenAI. Please check your key."
- Suggestion: "Common issues:"
  - "Key has been revoked or expired"
  - "Billing not set up on OpenAI account"
  - "Wrong API key (project vs user key)"
- Link to OpenAI troubleshooting

**Error (429 - Rate Limit)**:
```json
{
  "detail": "Too many validation attempts. Please try again in 600 seconds",
  "retry_after": 600
}
```

**UI Behavior**:
- Error message: "Too many validation attempts. Please try again in 10 minutes."
- Countdown timer: "Retry available in 9:54"
- Disable "Test Connection" button until countdown complete

**Requirements**: REQ-BYOM-6.5, REQ-BYOM-6.6

---

### Feature: The Lab (Agent Sessions)

#### Session Creation

**Endpoint**: `POST /api/v1/agent/sessions`

**Frontend Component**: `SessionCreationModal.tsx`

**Request Shape** (example):
```json
{
  "name": "BTC ETF Correlation Analysis",
  "goal": "What's the correlation between SEC ETF filings and BTC price?",
  "context": {
    "catalyst_event_id": "evt-123",  // Optional
    "data_sources": ["glass", "human", "catalyst", "exchange"],
    "time_range_days": 90
  },
  "model_config": {
    "provider": "system_default",  // or "user_openai", "user_google", "user_anthropic"
    "model": "gpt-4o"
  }
}
```

**Success Response (201)**:
```json
{
  "session_id": "sess-abc-123",
  "status": "initializing",
  "websocket_url": "wss://api.ohmycoins.com/ws/agent/session/sess-abc-123"
}
```

**UI Behavior**:
- Modal closes
- Navigate to `/lab/session/sess-abc-123`
- WebSocket connection established
- Terminal shows "Initializing agent orchestrator..."

**Error (400 - No LLM Credentials)**:
```json
{
  "detail": "User has not configured LLM credentials for provider 'openai'",
  "code": "NO_LLM_CREDENTIALS"
}
```

**UI Behavior**:
- Inline warning in model dropdown:
  ```
  ‚ö†Ô∏è OpenAI not configured
  [Configure in Settings] [Use System Default Instead]
  ```
- If user proceeds: Show error modal after submit:
  ```
  ‚ùå Cannot Start Session
  
  You selected "My OpenAI Model" but haven't configured your API key yet.
  
  [Go to Settings] [Select Different Model]
  ```

**Error (402 - Insufficient Credits)**:
```json
{
  "detail": "Insufficient system credits for this operation",
  "code": "INSUFFICIENT_CREDITS"
}
```

**UI Behavior**:
- Error modal:
  ```
  üí≥ Insufficient Credits
  
  This session requires approximately 500 credits.
  Your balance: 120 credits
  
  Options:
  - Use your own API key (BYOM)
  - Purchase more credits
  
  [Configure BYOM] [Buy Credits] [Cancel]
  ```

**Requirements**: REQ-AG-001, REQ-BYOM-7.1

---

### Feature: The Floor (Trading Execution)

#### Algorithm Deployment

**Endpoint**: `POST /api/v1/floor/deploy`

**Frontend Component**: `PromoteToFloorModal.tsx`

**Request Shape**:
```json
{
  "session_id": "sess-abc-123",  // Lab session with approved backtest
  "strategy_name": "BTC Mean Reversion Strategy",
  "config": {
    "max_position_size_aud": 1000,
    "max_open_positions": 3,
    "daily_loss_limit_aud": 500,
    "stop_loss_pct": 5.0,
    "take_profit_pct": 10.0,
    "trading_hours": "24/7",
    "cooldown_minutes": 15
  }
}
```

**Success Response (201)**:
```json
{
  "algorithm_id": "algo-xyz-789",
  "status": "deploying",
  "estimated_deployment_time_seconds": 10
}
```

**UI Behavior**:
- Modal shows progress:
  ```
  üöÄ Deploying Algorithm...
  
  ‚úÖ Validating strategy parameters
  ‚úÖ Creating execution worker
  ‚è≥ Subscribing to Exchange Ledger...
  ‚è≥ Initializing risk management
  ```
- On completion (status websocket message or polling):
  ```
  ‚úÖ Algorithm Deployed Successfully!
  
  BTC Mean Reversion Strategy is now live.
  
  [Go to Floor Dashboard]
  ```

**Error (403 - No Trading API Key)**:
```json
{
  "detail": "User has not configured trading API credentials",
  "code": "NO_TRADING_CREDENTIALS"
}
```

**UI Behavior**:
- Before deployment attempt, check if user has trading credentials
- If missing, show pre-flight modal:
  ```
  üîê Trading API Key Required
  
  To deploy algorithms, you must configure a CoinSpot
  Trading API Key with restricted permissions.
  
  ‚ö†Ô∏è Required permissions:
  - Read account balance
  - Place buy/sell orders
  
  ‚ùå Must NOT have:
  - Withdrawal permission
  
  [Configure API Key] [Cancel]
  ```

**Error (400 - Invalid Risk Parameters)**:
```json
{
  "detail": {
    "daily_loss_limit_aud": "Must be at least 50% of max_position_size_aud",
    "stop_loss_pct": "Must be between 1 and 50"
  },
  "code": "VALIDATION_ERROR"
}
```

**UI Behavior**:
- Highlight invalid fields in red
- Show inline errors:
  ```
  Daily Loss Limit: [500] AUD
  ‚ùå Must be at least 50% of max position size ($1500)
  
  Stop Loss: [0.5] %
  ‚ùå Must be between 1% and 50%
  ```

**Requirements**: REQ-FL-001, REQ-FL-005, NFR-FL-S-001

---

#### Emergency Stop (Kill Switch)

**Endpoint**: `POST /api/v1/floor/emergency-stop`

**Frontend Component**: `KillSwitch.tsx`

**Request**: Empty body (all algorithms stopped)

**Success Response (200)**:
```json
{
  "stopped_algorithms": ["algo-xyz-789"],
  "cancelled_orders": 2,
  "liquidated_positions": [
    {
      "coin": "BTC",
      "amount": 0.0106,
      "sell_price": 93210,
      "realized_pnl": -136.74
    }
  ],
  "final_pnl": -102.34
}
```

**UI Behavior**:
- Full-screen modal (non-dismissible until complete):
  ```
  üö® EMERGENCY STOP IN PROGRESS
  
  ‚úÖ All algorithms paused
  ‚úÖ All open orders cancelled (2)
  ‚è≥ Liquidating positions...
  
  [Please wait...]
  ```
- On completion:
  ```
  ‚úÖ Emergency Stop Complete
  
  Final P&L: -$102.34 (-10.2%)
  
  Closed positions:
  - BTC: Sold 0.0106 BTC | Loss: -$136.74
  - ETH: Sold 0.45 ETH | Gain: +$34.40
  
  [View Trading History] [Close]
  ```

**Error (500 - Liquidation Failed)**:
```json
{
  "detail": "Failed to liquidate position: BTC sell order rejected by exchange",
  "code": "LIQUIDATION_FAILED",
  "partial_success": true,
  "completed_actions": ["stopped_algorithms", "cancelled_orders"],
  "failed_actions": ["liquidate_btc_position"]
}
```

**UI Behavior**:
- Critical error modal:
  ```
  ‚ö†Ô∏è PARTIAL EMERGENCY STOP
  
  ‚úÖ Completed:
  - All algorithms stopped
  - Open orders cancelled
  
  ‚ùå Failed:
  - Could not liquidate BTC position (0.0106 BTC)
  
  Reason: Exchange rejected sell order
  
  MANUAL ACTION REQUIRED:
  1. Go to CoinSpot website
  2. Manually sell remaining BTC position
  
  [Open CoinSpot] [Retry Liquidation] [Acknowledge]
  ```

**Disconnected Fallback**:
- If WebSocket down: Use REST API (POST /api/v1/floor/emergency-stop)
- If REST also fails: Show "MANUAL INTERVENTION REQUIRED" with support phone

**Requirements**: REQ-FL-007, REQ-FL-008, REQ-FL-DISC-001

---

## Testing Patterns

### Mock Data Strategy

**Development Environment**:
- Use MSW (Mock Service Worker) to intercept API calls
- Mock files located in `frontend/src/mocks/handlers/`
- Enable via environment variable: `VITE_ENABLE_MOCKS=true`

**E2E Tests**:
- Playwright intercepts network requests
- Mock successful responses for happy paths
- Mock error responses for edge cases
- Example:
  ```typescript
  await page.route('**/api/v1/agent/sessions', route => {
    route.fulfill({
      status: 201,
      body: JSON.stringify({ session_id: 'test-123', status: 'initializing' })
    });
  });
  ```

**Staging Environment**:
- Use real backend API
- Dedicated test user accounts
- Sandbox mode for trading operations (no real money)

---

## API Versioning

**Current Version**: v1

**URL Pattern**: `/api/v1/{resource}`

**Breaking Change Policy**:
- Major version bump (v1 ‚Üí v2) for breaking changes
- Both versions supported for 6 months transition period
- Frontend must specify version in base URL
- Deprecated endpoints return warning header: `X-API-Deprecated: true`

**Non-Breaking Changes** (no version bump):
- Adding new endpoints
- Adding optional fields to requests
- Adding new fields to responses
- Extending enum values (if backwards compatible)

**Frontend Version Management**:
```typescript
const API_VERSION = 'v1';
const BASE_URL = `${import.meta.env.VITE_API_URL}/api/${API_VERSION}`;
```

---

## Performance Targets

| Operation Type | Target Response Time | User Experience |
|----------------|---------------------|-----------------|
| Simple GET (cached) | < 100ms | Instant |
| Complex GET (DB query) | < 500ms | Feels fast |
| POST/PUT (simple) | < 1s | Acceptable |
| POST/PUT (complex) | < 3s | Show progress |
| WebSocket message | < 100ms latency | Real-time |

**If backend exceeds targets**:
- < 3s: Show spinner or progress indicator
- 3-10s: Show progress with steps
- > 10s: Suggest action is processing in background, user can navigate away

---

## Security Patterns

### Sensitive Data Handling

**Never log or display**:
- Full API keys (always mask: `sk-proj-***...xyz`)
- User passwords (never sent to backend after login)
- Credit card numbers
- Webhook secrets

**Redaction Pattern**:
```typescript
function maskApiKey(key: string): string {
  if (key.length < 8) return '***';
  const prefix = key.substring(0, 7);  // e.g., "sk-proj"
  const suffix = key.substring(key.length - 3);  // last 3 chars
  return `${prefix}-***...${suffix}`;
}
```

**HTTPS Only**:
- All API calls must use HTTPS in production
- Development: Allow HTTP on localhost only
- Frontend should reject non-HTTPS connections in production build

**CORS Policy**:
- Allowed origins:
  - Production: `https://dashboard.ohmycoins.com`, `https://www.ohmycoins.com`
  - Staging: `https://staging.ohmycoins.com`
  - Development: `http://localhost:5173`, `http://localhost:3000`
- Credentials: `true` (allow cookies)
- Methods: `GET, POST, PUT, DELETE, PATCH, OPTIONS`

---

## Document Maintenance

**Update Triggers**:
- New global error handling pattern added
- New feature with unique API interaction needs
- Changes to authentication flow
- Performance target adjustments
- WebSocket protocol changes

**Review Schedule**:
- Weekly: Review PRs for new API patterns
- Per Release: Update based on backend API changes
- Quarterly: Full pattern audit for consistency

**Ownership**:
- Backend Lead: Responsible for backend behavior contracts
- Frontend Lead: Responsible for UI behavior patterns
- Product Manager: Approves user-facing error messages

---

**Document Version**: 1.0  
**Last Updated**: 2026-01-24  
**Next Review**: 2026-02-24  
**Source of Truth for Schemas**: FastAPI OpenAPI at `/api/v1/docs`
